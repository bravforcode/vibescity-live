name: Supabase DB Pull

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      fail_on_link_error:
        description: "Fail run when Supabase auth/link fails"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: supabase-db-pull
  cancel-in-progress: true

jobs:
  pull-schema:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate and link project
        id: link_project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_REF: ${{ vars.SUPABASE_PROJECT_REF }}
          SUPABASE_PROJECT_ID: ${{ vars.SUPABASE_PROJECT_ID }}
          SUPABASE_PROJECT_ID_SECRET: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          FAIL_ON_LINK_ERROR: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fail_on_link_error || 'false' }}
        run: |
          set -euo pipefail

          PROJECT_REF="${SUPABASE_PROJECT_REF:-}"
          if [ -z "${PROJECT_REF}" ]; then
            PROJECT_REF="${SUPABASE_PROJECT_ID:-}"
          fi
          if [ -z "${PROJECT_REF}" ]; then
            PROJECT_REF="${SUPABASE_PROJECT_ID_SECRET:-}"
          fi
          if [ -z "${PROJECT_REF}" ] && [ -n "${SUPABASE_URL:-}" ]; then
            HOST="$(printf '%s' "${SUPABASE_URL}" | sed -E 's#https?://([^/]+)/?.*#\1#')"
            if [[ "${HOST}" == *.supabase.* ]]; then
              PROJECT_REF="${HOST%%.*}"
            fi
          fi

          MISSING=()
          [ -n "${SUPABASE_ACCESS_TOKEN:-}" ] || MISSING+=("SUPABASE_ACCESS_TOKEN")
          [ -n "${SUPABASE_DB_PASSWORD:-}" ] || MISSING+=("SUPABASE_DB_PASSWORD")
          [ -n "${PROJECT_REF:-}" ] || MISSING+=("SUPABASE_PROJECT_REF|SUPABASE_PROJECT_ID|SUPABASE_URL")

          if [ "${#MISSING[@]}" -gt 0 ]; then
            echo "::warning::Skipping db pull. Missing inputs: ${MISSING[*]}"
            echo "linked=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! supabase login --token "${SUPABASE_ACCESS_TOKEN}"; then
            if [ "${FAIL_ON_LINK_ERROR}" = "true" ]; then
              echo "::error::supabase login failed."
              exit 1
            fi
            echo "::warning::supabase login failed; skipping db pull for this run."
            echo "linked=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! supabase link --project-ref "${PROJECT_REF}" --password "${SUPABASE_DB_PASSWORD}"; then
            if [ "${FAIL_ON_LINK_ERROR}" = "true" ]; then
              echo "::error::supabase link failed for project_ref=${PROJECT_REF}."
              exit 1
            fi
            echo "::warning::supabase link failed for project_ref=${PROJECT_REF}; skipping db pull for this run."
            echo "linked=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "linked=true" >> "$GITHUB_OUTPUT"
          echo "project_ref=${PROJECT_REF}" >> "$GITHUB_OUTPUT"

      - name: Pull remote schema
        if: ${{ steps.link_project.outputs.linked == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          PULL_LOG="$(mktemp)"
          if supabase db pull --linked 2>&1 | tee "${PULL_LOG}"; then
            echo "Supabase schema pull completed."
            exit 0
          fi

          if grep -qi "migration history does not match local files" "${PULL_LOG}"; then
            echo "::warning::Supabase migration history mismatch detected. Skipping automated db pull for this run."
            echo "::warning::Please reconcile migration history manually, then re-run this workflow."
            exit 0
          fi

          echo "Supabase db pull failed with non-recoverable error."
          cat "${PULL_LOG}"
          exit 1

      - name: Commit and push migration changes
        if: ${{ steps.link_project.outputs.linked == 'true' }}
        run: |
          set -euo pipefail
          if git diff --quiet -- supabase/migrations; then
            echo "No migration changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add supabase/migrations
          git commit -m "chore(db): automated supabase db pull"
          git push

      - name: Append workflow summary
        if: always()
        run: |
          {
            echo "## Supabase DB Pull"
            echo ""
            if [ "${{ steps.link_project.outputs.linked }}" = "true" ]; then
              echo "- Linked project ref: \`${{ steps.link_project.outputs.project_ref }}\`"
            else
              echo "- Skipped schema pull because Supabase auth/link was unavailable for this run."
              echo "- Provide valid \`SUPABASE_ACCESS_TOKEN\`, \`SUPABASE_DB_PASSWORD\`, and \`SUPABASE_PROJECT_REF\` (or \`SUPABASE_PROJECT_ID\` / \`SUPABASE_URL\`)."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
