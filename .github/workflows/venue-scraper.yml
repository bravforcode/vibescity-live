name: ğŸ‡¹ğŸ‡­ Thailand Venue Scraper

on:
  # Run every 15 minutes for fast data refresh
  schedule:
    - cron: '*/15 * * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Provinces per batch (5-10)'
        required: false
        default: '5'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  scrape-and-import:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“š Install dependencies
        run: |
          pip install httpx supabase python-dotenv

      - name: ğŸ•·ï¸ Run OSM Scraper
        working-directory: backend/scripts
        run: |
          echo "ğŸš€ Starting Thailand-wide venue scrape..."
          python osm_scraper.py
          echo "âœ… Scraping complete!"

      - name: ğŸ“¤ Import to Supabase
        working-directory: backend/scripts
        run: |
          echo "ğŸ“¥ Importing venues to Supabase..."
          python data_pipeline.py
          echo "âœ… Import complete!"

      - name: ğŸ“Š Generate Report
        working-directory: backend/scripts
        run: |
          echo "## ğŸ“Š Scrape Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f thailand_venues.json ]; then
            TOTAL=$(python -c "import json; print(json.load(open('thailand_venues.json'))['meta']['total_venues'])")
            PROVINCES=$(python -c "import json; print(json.load(open('thailand_venues.json'))['meta']['provinces_scraped'])")
            echo "- **Total Venues**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Provinces Scraped**: $PROVINCES" >> $GITHUB_STEP_SUMMARY
            echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No data file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: venue-data-${{ github.run_number }}
          path: backend/scripts/thailand_venues.json
          retention-days: 7
